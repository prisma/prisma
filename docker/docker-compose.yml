version: '3.8'

name: prisma-prisma

# For connection urls to the following instances, see
# https://github.com/prisma/prisma/blob/main/TESTING.md#environment-variables
services:
  # Postgres database
  postgres:
    image: postgres:14
    restart: unless-stopped
    # Uncomment the following line to enable query logging
    # command: ['postgres', '-c', 'log_statement=all']
    # Uncomment the following line to enable query logging with prepared statment logging
    # command: ['postgres', '-c', 'log_statement=all', '-c', 'log_min_duration_statement=0']
    environment:
      POSTGRES_DB: tests
      POSTGRES_USER: prisma
      POSTGRES_PASSWORD: prisma
    ports:
      - 9432:5432 # Postgres port
    healthcheck:
      # specifying user and database is needed to avoid `FATAL:  role "root" does not exist`
      # spam in the logs
      test: ['CMD', 'pg_isready', '-U', 'prisma', '-d', 'tests']
      interval: 5s
      timeout: 2s
      retries: 20

  # PgBouncer
  pgbouncer:
    image: bitnami/pgbouncer:1.21.0
    environment:
      POSTGRESQL_HOST: postgres
      POSTGRESQL_USERNAME: prisma
      POSTGRESQL_PASSWORD: prisma
      POSTGRESQL_DATABASE: tests
      POSTGRESQL_PORT: 5432
      PGBOUNCER_DATABASE: '*'
      PGBOUNCER_POOL_MODE: 'transaction'
      PGBOUNCER_MAX_CLIENT_CONN: '1000'
      PGBOUNCER_MAX_PREPARED_STATEMENTS: 100
      BITNAMI_DEBUG: 1
    links:
      - postgres:postgres
    ports:
      - 5432:6432 # PgBouncer port
    # volumes:
    #   - ./pgbouncer/conf/:/bitnami/pgbouncer/conf/

  postgres_isolated:
    image: postgres:10
    restart: unless-stopped
    environment:
      - POSTGRES_DB=tests
      - POSTGRES_USER=prisma
      - POSTGRES_PASSWORD=prisma
    ports:
      - '5435:5432'
    healthcheck:
      test: ['CMD', 'pg_isready']
      interval: 5s
      timeout: 2s
      retries: 20

  cockroachdb:
    image: prismagraphql/cockroachdb-custom:23.1
    restart: unless-stopped
    command: start-single-node --insecure
    ports:
      - '26257:26257'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:8080/health?ready=1']
      interval: 5s
      timeout: 2s
      retries: 20

  # Planetscale
  # From https://github.com/prisma/prisma-engines/blob/976a00ae3c30ab9507fa742986c9c6f5327ba10f/docker-compose.yml
  vitess-8:
    image: vitess/vttestserver:mysql80@sha256:66266b9fb26c1ac8841798c054b0129c1dc3dc677315d314fa42ad84556ba6e4
    restart: unless-stopped
    ports:
      - 33807:33807
    environment:
      PORT: '33804' # unused in testing, but required by vttestserver
      KEYSPACES: 'unsharded' # unused in testing, but required by vttestserver
      NUM_SHARDS: '1' # unused in testing, but required by vttestserver
      MYSQL_BIND_HOST: '0.0.0.0'
      FOREIGN_KEY_MODE: 'disallow'
      MYSQL_MAX_CONNECTIONS: 100000
      TABLET_REFRESH_INTERVAL: '1s'
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h127.0.0.1', '-P33807']
      interval: 5s
      timeout: 2s
      retries: 20

  mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password --lower_case_table_names=1
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=tests
      - MYSQL_USER=prisma
    ports:
      - '3306:3306'
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h127.0.0.1', '-P3306']
      interval: 5s
      timeout: 2s
      retries: 20

  mysql_isolated:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password --lower_case_table_names=1
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=tests
      - MYSQL_USER=prisma
      - MYSQL_PASSWORD=prisma
    ports:
      - '3307:3306'
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h127.0.0.1', '-P3306']
      interval: 5s
      timeout: 2s
      retries: 20

  mariadb:
    image: mariadb:10
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=tests
      - MYSQL_USER=prisma
      - MYSQL_PASSWORD=prisma
    ports:
      - '4306:3306'
    healthcheck:
      test: ['CMD', '/usr/local/bin/healthcheck.sh', '--connect']
      interval: 5s
      timeout: 2s
      retries: 20

  mssql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Pr1sm4_Pr1sm4
    ports:
      - '1433:1433'
    healthcheck:
      test: ['CMD', '/opt/mssql-tools/bin/sqlcmd', '-Usa', '-PPr1sm4_Pr1sm4', '-Q', 'select 1']
      interval: 5s
      timeout: 2s
      retries: 20

  mongodb_migrate:
    image: mongo:4
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: prisma
      MONGO_INITDB_DATABASE: tests-migrate
    ports:
      - '27017:27017'
    healthcheck:
      test: ['CMD', 'mongo', 'admin', '--port', '27017', '--eval', "db.adminCommand('ping')"]
      interval: 5s
      timeout: 2s
      retries: 20

  mongodb_migrate_seed:
    build: ./mongodb_migrate_seed
    depends_on:
      - mongodb_migrate

  # Replica Set (required for Prisma Client)
  mongo:
    build: ./mongodb_replica
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: prisma
      MONGO_REPLICA_HOST: 127.0.0.1
      MONGO_REPLICA_PORT: 27018
    ports:
      - '27018:27018'
    restart: always # restart between reboots
    healthcheck:
      test: ['CMD', 'mongo', 'admin', '--port', '27018', '--eval', "db.adminCommand('ping')"]
      interval: 5s
      timeout: 2s
      retries: 20

  neon_wsproxy:
    image: ghcr.io/neondatabase/wsproxy:latest
    environment:
      APPEND_PORT: 'postgres:5432'
      ALLOW_ADDR_REGEX: '.*'
      LOG_TRAFFIC: 'true'
      LOG_CONN_INFO: 'true'
    ports:
      - '5488:80'
    depends_on:
      - postgres
    restart: always
    healthcheck:
      test: ['CMD', 'nc', '-z', '127.0.0.1', '80']
      interval: 5s
      timeout: 2s
      retries: 20

  planetscale_proxy:
    build: ./planetscale_proxy
    environment:
      MYSQL_HOST: 'vitess-8' # docker url
      MYSQL_PORT: 33807
      MYSQL_DATABASE: 'test-0000-00000000'
    ports:
      - '8085:8085'
    depends_on:
      - vitess-8
    restart: always
    healthcheck:
      test: ['CMD', 'nc', '-z', '127.0.0.1', '8085']
      interval: 5s
      timeout: 2s
      retries: 20
