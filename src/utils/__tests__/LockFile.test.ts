import { deserializeLockFile, serializeLockFile } from "../LockFile";
import { LockFile } from "../../types";
import dedent from "strip-indent";

describe("LockFile", () => {
  test("parse file with conflicts", () => {
    const file = dedent(`
  # THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
  # prisma lockfile v1
  # You are seeing a conflict here? Just execute \`prisma lift --fix\`
  # Read more about conflict resolution here: TODO
  
  20190528171624-test
  20190528171724-test-2
  20190528171624-test-3
  20190528171724-test-4
  <<<<<<< HEAD
  20190528171724-teasdasdst-6
  =======
  20190528171724-test-5
  >>>>>>> master
  `);
    expect(deserializeLockFile(file)).toMatchInlineSnapshot(`
                  Object {
                    "localBranch": "HEAD",
                    "localMigrations": Array [
                      "20190528171624-test",
                      "20190528171724-test-2",
                      "20190528171624-test-3",
                      "20190528171724-test-4",
                      "20190528171724-teasdasdst-6",
                    ],
                    "remoteBranch": "master",
                    "remoteMigrations": Array [
                      "20190528171624-test",
                      "20190528171724-test-2",
                      "20190528171624-test-3",
                      "20190528171724-test-4",
                      "20190528171724-test-5",
                    ],
                  }
            `);
  });

  test("parse correct file", () => {
    const file = dedent(`
  # THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
  # prisma lockfile v1
  # You are seeing a conflict here? Just execute \`prisma lift --fix\`
  # Read more about conflict resolution here: TODO
  
  20190528171624-test
  20190528171724-test-2
  20190528171624-test-3
  20190528171724-test-4
  20190528171724-test-5
  `);
    expect(deserializeLockFile(file)).toMatchInlineSnapshot(`
            Object {
              "localBranch": undefined,
              "localMigrations": Array [
                "20190528171624-test",
                "20190528171724-test-2",
                "20190528171624-test-3",
                "20190528171724-test-4",
                "20190528171724-test-5",
              ],
              "remoteBranch": undefined,
              "remoteMigrations": Array [
                "20190528171624-test",
                "20190528171724-test-2",
                "20190528171624-test-3",
                "20190528171724-test-4",
                "20190528171724-test-5",
              ],
            }
        `);
  });

  test("serialize file correctly", () => {
    const lockFile: LockFile = {
      localMigrations: [
        "20190528171624-test",
        "20190528171724-test-2",
        "20190528171624-test-3",
        "20190528171724-test-4"
      ],
      remoteMigrations: []
    };
    expect(serializeLockFile(lockFile)).toMatchInlineSnapshot(`
      "# IF THERE'S A GIT CONFLICT IN THIS FILE, DON'T SOLVE IT MANUALLY!
      # INSTEAD EXECUTE \`prisma lift fix\`
      # lift lockfile v1
      # Read more about conflict resolution here: TODO

      20190528171624-test
      20190528171724-test-2
      20190528171624-test-3
      20190528171724-test-4"
    `);
  });
});
