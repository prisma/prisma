import { deserializeLockFile, serializeLockFile } from '../LockFile'
import { LockFile } from '../../types'
import dedent from 'strip-indent'

describe('LockFile', () => {
  test('parse file with conflicts', () => {
    const file = dedent(`
  # THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
  # Prisma Migrate lockfile v1
  
  20190528171624-test
  20190528171724-test-2
  20190528171624-test-3
  20190528171724-test-4
  <<<<<<< HEAD
  20190528171724-teasdasdst-6
  =======
  20190528171724-test-5
  >>>>>>> master
  `)
    expect(deserializeLockFile(file)).toMatchInlineSnapshot(`
      Object {
        localBranch: HEAD,
        localMigrations: Array [
          20201231000000-test,
          20201231000000-test-2,
          20201231000000-test-3,
          20201231000000-test-4,
          20201231000000-teasdasdst-6,
        ],
        remoteBranch: master,
        remoteMigrations: Array [
          20201231000000-test,
          20201231000000-test-2,
          20201231000000-test-3,
          20201231000000-test-4,
          20201231000000-test-5,
        ],
      }
    `)
  })

  test('parse correct file', () => {
    const file = dedent(`
  # THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
  # Prisma Migrate lockfile v1
  
  20190528171624-test
  20190528171724-test-2
  20190528171624-test-3
  20190528171724-test-4
  20190528171724-test-5
  `)
    expect(deserializeLockFile(file)).toMatchInlineSnapshot(`
      Object {
        localBranch: undefined,
        localMigrations: Array [
          20201231000000-test,
          20201231000000-test-2,
          20201231000000-test-3,
          20201231000000-test-4,
          20201231000000-test-5,
        ],
        remoteBranch: undefined,
        remoteMigrations: Array [
          20201231000000-test,
          20201231000000-test-2,
          20201231000000-test-3,
          20201231000000-test-4,
          20201231000000-test-5,
        ],
      }
    `)
  })

  test('serialize file correctly', () => {
    const lockFile: LockFile = {
      localMigrations: [
        '20190528171624-test',
        '20190528171724-test-2',
        '20190528171624-test-3',
        '20190528171724-test-4',
      ],
      remoteMigrations: [],
    }
    expect(serializeLockFile(lockFile)).toMatchInlineSnapshot(`
      # Prisma Migrate lockfile v1

      20201231000000-test
      20201231000000-test-2
      20201231000000-test-3
      20201231000000-test-4
    `)
  })
})
