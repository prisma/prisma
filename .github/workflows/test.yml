name: CI

# Run on push only for main, if not it will trigger push & pull_request on PRs at the same time
on:
  push:
    branches:
      - main
    paths-ignore:
      # Any update here needs to be done for
      # - `pull_request` see below
      # - https://github.com/prisma/prisma/blob/main/.buildkite/test/buildkite-entry.sh
      # - https://github.com/prisma/prisma/blob/main/.buildkite/publish/buildkite-entry.sh
      - '*.md'
      - '.devcontainer/**'
      - '.vscode/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'docs/**'
      - 'examples/**'
      - 'LICENSE'
      - '.github/CODEOWNERS'
      - '.buildkite/**'
      - '.dockerignore'
      - '*.bench.ts'
      - 'scripts/ci/publish.ts'
      - 'graphs/**'
  pull_request:
    paths-ignore:
      # Any update here needs to be done for
      # - `push`see before
      # - https://github.com/prisma/prisma/blob/main/.buildkite/test/buildkite-entry.sh
      # - https://github.com/prisma/prisma/blob/main/.buildkite/publish/buildkite-entry.sh
      - '*.md'
      - '.devcontainer/**'
      - '.vscode/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'docs/**'
      - 'examples/**'
      - 'LICENSE'
      - '.github/CODEOWNERS'
      - '.buildkite/**'
      - '.dockerignore'
      - '*.bench.ts'
      - 'scripts/ci/publish.ts'
      - 'graphs/**'
  #   schedule:
  #     # https://crontab.guru - “At every 15th minute past every hour from 3 through 5.”
  #     - cron: '*/15 3-5 * * *'
  workflow_dispatch:

env:
  HAS_BUILDPULSE_SECRETS: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID != '' && secrets.BUILDPULSE_SECRET_ACCESS_KEY != '' }}
  PRISMA_TELEMETRY_INFORMATION: 'prisma test.yml'
  # To hide "Update available 0.0.0 -> x.x.x"
  PRISMA_HIDE_UPDATE_MESSAGE: true

jobs:
  detect_jobs_to_run:
    name: Detect jobs to run
    runs-on: ubuntu-latest
    outputs:
      jobs: ${{ steps.detect.outputs.jobs }}
    steps:
      - id: checkout
        uses: actions/checkout@v3
      - id: files
        uses: Ana06/get-changed-files@v2.2.0 # it's a fork of jitterbit/get-changed-files@v1 which works better with pull requests
        with:
          format: 'json'
        continue-on-error: true # This allow this job to fail (e.g. for scheduled runs), and then the `detect` step below will default to `all`
      - id: detect
        run: ./.github/workflows/scripts/detect-jobs-to-run.js <<< '${{ steps.files.outputs.all }}'

  # From https://github.com/marketplace/actions/skip-duplicate-actions
  # This action cleans up previously running instances of a workflow on the same branch.
  # This accomplishes the task of automatically cancelling CI runs on pushes to the same branch,
  # which is a common feature in most CI systems but currently not possible with GitHub actions.
  cleanup-runs:
    continue-on-error: true
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/') && !contains(github.actor, 'renovate')"
    steps:
      - uses: fkirc/skip-duplicate-actions@v5
        with:
          cancel_others: 'true'

  #
  # Linting
  #
  lint:
    timeout-minutes: 7
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: '16'

      # https://github.com/actions/toolkit/blob/master/docs/commands.md#problem-matchers
      # Matchers are added in setup-node
      # https://github.com/actions/setup-node/blob/bacd6b4b3ac3127b28a1e1920c23bf1c2cadbb85/src/main.ts#L54-L60
      - name: Disable GitHub annotations from linting
        run: |
          echo "::remove-matcher owner=eslint-compact::"
          echo "::remove-matcher owner=eslint-stylish::"

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run lint && pnpm run check-engines-override
        working-directory: ./

  #
  # CLIENT (without types test)
  #
  client:
    timeout-minutes: 35
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library', 'binary']
        engineProtocol: ['graphql', 'json']
        os: [buildjet-4vcpu-ubuntu-2004]
        node: [16, 18]

    env:
      CI: true
      SKIP_GIT: true
      GITHUB_CONTEXT: ${{ toJson(github) }}
      TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
      TEST_POSTGRES_ISOLATED_URI: postgres://prisma:prisma@localhost:5435/tests
      TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
      TEST_MYSQL_ISOLATED_URI: mysql://root:root@localhost:3307/tests
      TEST_MSSQL_URI: mssql://SA:Pr1sm4_Pr1sm4@localhost:1433/master
      TEST_MSSQL_JDBC_URI: sqlserver://localhost:1433;database=master;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;
      TEST_MSSQL_JDBC_URI_MIGRATE: 'sqlserver://localhost:1433;database=tests-migrate;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
      TEST_MONGO_URI: 'mongodb://root:prisma@localhost:27018/tests?authSource=admin'
      TEST_COCKROACH_URI: 'postgresql://prisma@localhost:26257/tests'
      TEST_COCKROACH_URI_MIGRATE: 'postgresql://prisma@localhost:26257/tests-migrate'
      TEST_COCKROACH_SHADOWDB_URI_MIGRATE: 'postgres://prisma:prisma@localhost:26257/tests-migrate-shadowdb'
      TEST_FUNCTIONAL_POSTGRES_URI: 'postgres://prisma:prisma@localhost:5432/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_MYSQL_URI: 'mysql://root:root@localhost:3306/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_VITESS_8_URI: 'mysql://root:root@localhost:33807/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_MSSQL_URI: 'sqlserver://localhost:1433;database=PRISMA_DB_NAME;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
      TEST_FUNCTIONAL_MONGO_URI: 'mongodb://root:prisma@localhost:27018/PRISMA_DB_NAME?authSource=admin'
      TEST_FUNCTIONAL_COCKROACH_URI: 'postgresql://prisma@localhost:26257/PRISMA_DB_NAME'
      NODE_OPTIONS: '--max-old-space-size=8096'
      JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/functional/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}/${{ matrix.engineProtocol }}'
      JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set CLI Engine Type
        run: |
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Client Engine Type
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Engine Protocol
        run: |
          echo "PRISMA_ENGINE_PROTOCOL=${{ matrix.engineProtocol }}" >> $GITHUB_ENV

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres postgres_isolated mysql mysql_isolated mssql mongo cockroachdb vitess-8

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev

      # Run the functional test suite
      - run: pnpm run test:functional
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}
        working-directory: packages/client
      # And run  all the other tests (except the types tests)
      - run: pnpm run test-notypes
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}
        working-directory: packages/client

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/client/src/__tests__/coverage/clover.xml
          flags: client,${{ matrix.os }},${{ matrix.queryEngine }}
          name: client-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Upload test results to BuildPulse for flaky test detection
        # Only run this step for branches where we have access to secrets.
        # Run this step even when the tests fail. Skip if the workflow is cancelled.
        if: env.HAS_BUILDPULSE_SECRETS == 'true' && !cancelled() && github.event_name == 'schedule'
        uses: Workshop64/buildpulse-action@main
        with:
          account: 17219288
          repository: 192925833
          path: packages
          key: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
          secret: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}

      - uses: actions/upload-artifact@v3
        if: github.event_name == 'schedule'
        with:
          name: ${{ github.job }}_${{ matrix.os }}_node-${{ matrix.node }}_dataproxy_junit.xml
          path: packages/*/junit*.xml

  #
  # CLIENT (functional tests with mini-proxy)
  #
  client-dataproxy:
    timeout-minutes: 35
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        os: [buildjet-4vcpu-ubuntu-2004]
        node: [14, 16, 18]
        engineProtocol: ['graphql', 'json']

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mssql mongo cockroachdb vitess-8

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test:functional --data-proxy
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_FUNCTIONAL_POSTGRES_URI: 'postgres://prisma:prisma@localhost:5432/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_MYSQL_URI: 'mysql://root:root@localhost:3306/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_VITESS_8_URI: 'mysql://root:root@localhost:33807/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_MSSQL_URI: 'sqlserver://localhost:1433;database=PRISMA_DB_NAME;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
          TEST_FUNCTIONAL_MONGO_URI: 'mongodb://root:prisma@localhost:27018/PRISMA_DB_NAME?authSource=admin'
          TEST_FUNCTIONAL_COCKROACH_URI: 'postgresql://prisma@localhost:26257/PRISMA_DB_NAME'
          NODE_OPTIONS: '--max-old-space-size=8096'
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/functional/${{ matrix.os }}/node-${{ matrix.node }}/dataproxy'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true
          PRISMA_ENGINE_PROTOCOL: '${{ matrix.engineProtocol }}'

      - run: pnpm run test:functional --data-proxy --edge-client
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_FUNCTIONAL_POSTGRES_URI: 'postgres://prisma:prisma@localhost:5432/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_MYSQL_URI: 'mysql://root:root@localhost:3306/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_VITESS_8_URI: 'mysql://root:root@localhost:33807/PRISMA_DB_NAME'
          TEST_FUNCTIONAL_MSSQL_URI: 'sqlserver://localhost:1433;database=PRISMA_DB_NAME;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
          TEST_FUNCTIONAL_MONGO_URI: 'mongodb://root:prisma@localhost:27018/PRISMA_DB_NAME?authSource=admin'
          TEST_FUNCTIONAL_COCKROACH_URI: 'postgresql://prisma@localhost:26257/PRISMA_DB_NAME'
          NODE_OPTIONS: '--max-old-space-size=8096'
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/functional/${{ matrix.os }}/node-${{ matrix.node }}/dataproxy'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true
          PRISMA_ENGINE_PROTOCOL: '${{ matrix.engineProtocol }}'

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/client/src/__tests__/coverage/clover.xml
          flags: client,${{ matrix.os }},dataproxy
          name: client-${{ matrix.os }}-dataproxy

      - name: Upload test results to BuildPulse for flaky test detection
        # Only run this step for branches where we have access to secrets.
        # Run this step even when the tests fail. Skip if the workflow is cancelled.
        if: env.HAS_BUILDPULSE_SECRETS == 'true' && !cancelled() && github.event_name == 'schedule'
        uses: Workshop64/buildpulse-action@main
        with:
          account: 17219288
          repository: 192925833
          path: packages
          key: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
          secret: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}

      - uses: actions/upload-artifact@v3
        if: github.event_name == 'schedule'
        with:
          name: ${{ github.job }}_${{ matrix.os }}_node-${{ matrix.node }}_dataproxy_junit.xml
          path: packages/*/junit*.xml

  #
  # CLIENT (memory tests)
  #
  client-memory:
    timeout-minutes: 15
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library'] # TODO: binary engine is leaking at the moment
        os: [buildjet-4vcpu-ubuntu-2004]
        node: [14, 16, 18]
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres # mysql mysql_isolated mssql mongo cockroachdb

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test:memory
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
          TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
          TEST_MSSQL_URI: mssql://SA:Pr1sm4_Pr1sm4@localhost:1433/master
          TEST_MONGO_URI: 'mongodb://root:prisma@localhost:27018/tests?authSource=admin'
          TEST_COCKROACH_URI: 'postgresql://prisma@localhost:26257/tests'

      - uses: actions/github-script@v6
        if: ${{ failure() && github.event_name == 'pull_request' }}
        id: upload-report
        env:
          NODE_VERSION: ${{ matrix.node }}
        with:
          github-token: ${{ secrets.BOT_TOKEN }}
          script: |
            const fs = require('fs')
            const nodeVersion = process.env.NODE_VERSION
            const reportPath = `client-memory-test/${context.issue.number}/${context.sha}.${nodeVersion}.html`
            const url = `https://prisma.github.io/ci-reports/${reportPath}`
            const localReport = './packages/client/tests/memory/memory-report.html'
            if (fs.existsSync(localReport)) {
              await github.rest.repos.createOrUpdateFileContents({
                owner: 'prisma',
                repo: 'ci-reports',
                branch: 'gh-pages',
                path: reportPath,
                message: `Add memory results for PR ${context.issue.number}`,
                content: fs.readFileSync(localReport, 'base64'),
              });
              core.setOutput('url', url);
            }

      - name: Find report comment
        uses: peter-evans/find-comment@v2
        id: fc
        if: ${{ always() && github.event_name == 'pull_request' }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Client memory tests, node ${{ matrix.node}}, ${{ matrix.queryEngine }}:'

      - name: Create or update remote comment (failure)
        uses: peter-evans/create-or-update-comment@v3
        if: ${{ failure() && steps.upload-report.outputs.url }}
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Client memory tests, node ${{ matrix.node}}, ${{ matrix.queryEngine }}:

            ❌ Failure, [see report](${{ steps.upload-report.outputs.url }}).
          edit-mode: replace

      - name: Create or update remote comment (success)
        uses: peter-evans/create-or-update-comment@v3
        if: ${{ success() && steps.fc.outputs.comment-id != '' }}
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Client memory tests, node ${{ matrix.node}}, ${{ matrix.queryEngine }}:

            ✅ Success
          edit-mode: replace

  #
  # CLIENT test:e2e
  #
  client-e2e:
    timeout-minutes: 25
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node: [16]

    steps:
      - uses: actions/checkout@v3

      # Not currently needed, but we might need it in the future
      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mssql mongo cockroachdb vitess-8

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test:e2e --skipBuild --verbose --runInBand
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          NODE_OPTIONS: '--max-old-space-size=8096'

  #
  # CLIENT test:functional:code --relation-mode-tests-only for `relationMode-in-separate-gh-action` tests
  #
  client-relationMode:
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        relationMode: ['', 'foreignKeys', 'prisma']
        os: [ubuntu-latest]
        node: [16]

    env:
      CI: true
      SKIP_GIT: true
      GITHUB_CONTEXT: ${{ toJson(github) }}
      TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
      TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
      TEST_MSSQL_URI: mssql://SA:Pr1sm4_Pr1sm4@localhost:1433/master
      TEST_MSSQL_JDBC_URI: sqlserver://localhost:1433;database=master;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;
      TEST_MSSQL_JDBC_URI_MIGRATE: 'sqlserver://localhost:1433;database=tests-migrate;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
      TEST_MONGO_URI: 'mongodb://root:prisma@localhost:27018/tests?authSource=admin'
      TEST_COCKROACH_URI: 'postgresql://prisma@localhost:26257/tests'
      TEST_COCKROACH_URI_MIGRATE: 'postgresql://prisma@localhost:26257/tests-migrate'
      TEST_COCKROACH_SHADOWDB_URI_MIGRATE: 'postgres://prisma:prisma@localhost:26257/tests-migrate-shadowdb'
      TEST_FUNCTIONAL_POSTGRES_URI: 'postgres://prisma:prisma@localhost:5432/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_MYSQL_URI: 'mysql://root:root@localhost:3306/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_VITESS_8_URI: 'mysql://root:root@localhost:33807/PRISMA_DB_NAME'
      TEST_FUNCTIONAL_MSSQL_URI: 'sqlserver://localhost:1433;database=PRISMA_DB_NAME;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
      TEST_FUNCTIONAL_MONGO_URI: 'mongodb://root:prisma@localhost:27018/PRISMA_DB_NAME?authSource=admin'
      TEST_FUNCTIONAL_COCKROACH_URI: 'postgresql://prisma@localhost:26257/PRISMA_DB_NAME'
      NODE_OPTIONS: '--max-old-space-size=8096'
      JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/functional/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
      JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

    steps:
      - uses: actions/checkout@v3

      - name: Set RELATION_MODE custom test env var
        run: |
          echo "RELATION_MODE=${{ matrix.relationMode }}"
          if [ ! -z "${{ matrix.relationMode }}" ]; then echo "RELATION_MODE=${{ matrix.relationMode }}" >> $GITHUB_ENV; fi

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mssql mongo cockroachdb vitess-8

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      # shouldn't take more than 15 minutes
      - name: 1 to 1
        run: pnpm run test:functional:code --relation-mode-tests-only relationMode-in-separate-gh-action/tests_1-to-1.ts
        working-directory: packages/client

      # shouldn't take more than 15 minutes
      - name: 1 to n
        run: pnpm run test:functional:code --relation-mode-tests-only relationMode-in-separate-gh-action/tests_1-to-n.ts
        working-directory: packages/client

      # shouldn't take more than 15 minutes
      - name: m to n (SQL databases)
        run: pnpm run test:functional:code --relation-mode-tests-only relationMode-in-separate-gh-action/tests_m-to-n.ts
        working-directory: packages/client

      - name: m to n (MongoDB)
        run: pnpm run test:functional:code --relation-mode-tests-only relationMode-in-separate-gh-action/tests_m-to-n-MongoDB.ts
        working-directory: packages/client

      - name: Upload test results to BuildPulse for flaky test detection
        # Only run this step for branches where we have access to secrets.
        # Run this step even when the tests fail. Skip if the workflow is cancelled.
        if: env.HAS_BUILDPULSE_SECRETS == 'true' && !cancelled() && github.event_name == 'schedule'
        uses: Workshop64/buildpulse-action@main
        with:
          account: 17219288
          repository: 192925833
          path: packages
          key: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
          secret: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}

      - uses: actions/upload-artifact@v3
        if: github.event_name == 'schedule'
        with:
          name: ${{ github.job }}_${{ matrix.os }}_node-${{ matrix.node }}_${{ matrix.queryEngine }}_junit.xml
          path: packages/*/junit*.xml

  #
  # CLIENT (types tests only)
  #
  client-types:
    timeout-minutes: 15
    runs-on: buildjet-4vcpu-ubuntu-2004

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}

    strategy:
      fail-fast: false
      matrix:
        node: [16]

    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test src/__tests__/types/types.test.ts
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/client/src/__tests__/coverage/clover.xml
          flags: client-types,${{ matrix.os }},library,binary
          name: client-types-${{ matrix.os }}

  #
  # INTEGRATION-TESTS
  #
  integration-tests:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-integration-tests-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library', 'binary']
        node: [16]

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set CLI Engine Type
        run: |
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Client Engine Type
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mariadb mssql

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test
        working-directory: packages/integration-tests
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_POSTGRES_BASE_URI: postgres://prisma:prisma@localhost:5432
          TEST_MYSQL_BASE_URI: mysql://root:root@localhost:3306
          TEST_MARIADB_BASE_URI: mysql://root:root@localhost:4306
          TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
          TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
          TEST_MARIADB_URI: mysql://root:root@localhost:4306/tests
          TEST_MSSQL_URI: mssql://SA:Pr1sm4_Pr1sm4@localhost:1433/master

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/integration-tests/src/__tests__/coverage/clover.xml
          flags: integration-tests,${{ matrix.node }},${{ matrix.queryEngine }}
          name: integration-tests-${{ matrix.node }}-${{ matrix.queryEngine }}

  #
  # `@prisma/internals`
  #
  internals:
    timeout-minutes: 15
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-internals-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library', 'binary']
        os: [ubuntu-latest]
        node: [16, 18]

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mssql

      - name: Set CLI Engine Type
        run: |
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Client Engine Type
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test
        working-directory: packages/internals
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
          TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
          TEST_MARIADB_URI: mysql://root:root@localhost:4306/tests
          TEST_MSSQL_JDBC_URI: sqlserver://localhost:1433;database=master;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/internals/src/__tests__/coverage/clover.xml
          flags: internals,${{ matrix.os }},${{ matrix.queryEngine }}
          name: internals-${{ matrix.os }}-${{ matrix.queryEngine }}

  #
  # MIGRATE
  #
  migrate:
    timeout-minutes: 15
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-migrate-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library', 'binary']
        os: [ubuntu-latest]
        node: [16, 18]

    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        if: "${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}"
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker-compose -f docker/docker-compose.yml up --detach postgres mysql mssql mongodb_migrate mongodb_migrate_seed cockroachdb

      - name: Set CLI Engine Type
        run: |
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Client Engine Type
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test
        working-directory: packages/migrate
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
          TEST_POSTGRES_URI_MIGRATE: postgres://prisma:prisma@localhost:5432/tests-migrate
          TEST_POSTGRES_SHADOWDB_URI_MIGRATE: postgres://prisma:prisma@localhost:5432/tests-migrate-shadowdb
          TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests
          TEST_MYSQL_URI_MIGRATE: mysql://root:root@localhost:3306/tests-migrate
          TEST_MYSQL_SHADOWDB_URI_MIGRATE: mysql://root:root@localhost:3306/tests-migrate-shadowdb
          TEST_MSSQL_URI: mssql://SA:Pr1sm4_Pr1sm4@localhost:1433/master
          TEST_MSSQL_JDBC_URI_MIGRATE: 'sqlserver://localhost:1433;database=tests-migrate;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
          TEST_MSSQL_SHADOWDB_JDBC_URI_MIGRATE: 'sqlserver://localhost:1433;database=tests-migrate-shadowdb;user=SA;password=Pr1sm4_Pr1sm4;trustServerCertificate=true;'
          TEST_MONGO_URI_MIGRATE: 'mongodb://root:prisma@localhost:27017/tests-migrate?authSource=admin'
          TEST_COCKROACH_URI: 'postgresql://prisma@localhost:26257/tests'
          TEST_COCKROACH_URI_MIGRATE: 'postgresql://prisma@localhost:26257/tests-migrate'
          TEST_COCKROACH_SHADOWDB_URI_MIGRATE: 'postgres://prisma:prisma@localhost:26257/tests-migrate-shadowdb'
          TEST_MONGO_URI_MIGRATE_EXISTING_DB: 'mongodb://root:prisma@localhost:27017/tests-migrate-existing-db?authSource=admin'

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/migrate/src/__tests__/coverage/clover.xml
          flags: migrate,${{ matrix.os }},${{ matrix.queryEngine }}
          name: migrate-${{ matrix.os }}-${{ matrix.queryEngine }}

  #
  # CLI-COMMANDS
  #
  cli-commands:
    timeout-minutes: 10
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-cli-') }}

    strategy:
      fail-fast: false
      matrix:
        queryEngine: ['library', 'binary']
        os: [ubuntu-latest]
        node: [16, 18]

    env:
      TEST_POSTGRES_URI: postgres://prisma:prisma@localhost:5432/tests
      TEST_MYSQL_URI: mysql://root:root@localhost:3306/tests

    steps:
      - uses: actions/checkout@v3

      - name: Set CLI Engine Type
        run: |
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set Client Engine Type
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test
        working-directory: packages/cli
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/cli/src/__tests__/coverage/clover.xml
          flags: cli,${{ matrix.os }},${{ matrix.queryEngine }}
          name: cli-${{ matrix.os }}-${{ matrix.queryEngine }}

  #
  # All the other packages!
  #
  others:
    timeout-minutes: 10
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node: [16, 18]

    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - run: pnpm run test
        name: 'debug'
        working-directory: packages/debug
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/debug/src/__tests__/coverage/clover.xml
          flags: debug,${{ matrix.os }},library,binary
          name: debug-${{ matrix.os }}

      - run: pnpm run test
        name: 'engine-core'
        working-directory: packages/engine-core
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/engine-core/src/__tests__/coverage/clover.xml
          flags: engine-core,${{ matrix.os }},library,binary
          name: engine-core-${{ matrix.os }}

      - run: pnpm run test
        name: 'generator-helper'
        working-directory: packages/generator-helper
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/generator-helper/src/__tests__/coverage/clover.xml
          flags: generator-helper,${{ matrix.os }},library,binary
          name: generator-helper-${{ matrix.os }}

      - run: pnpm run test
        name: 'get-platform'
        working-directory: packages/get-platform
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/get-platform/src/__tests__/coverage/clover.xml
          flags: get-platform,${{ matrix.os }},library,binary
          name: get-platform-${{ matrix.os }}

      - run: pnpm run test
        name: 'fetch-engine'
        working-directory: packages/fetch-engine
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/fetch-engine/src/__tests__/coverage/clover.xml
          flags: fetch-engine,${{ matrix.os }},library,binary
          name: fetch-engine-${{ matrix.os }}

      - run: pnpm run test
        name: 'engines'
        working-directory: packages/engines
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/engines/src/__tests__/coverage/clover.xml
          flags: engines,${{ matrix.os }},library,binary
          name: engines-${{ matrix.os }}

      - run: pnpm run test
        name: 'instrumentation'
        working-directory: packages/instrumentation
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/instrumentation/src/__tests__/coverage/clover.xml
          flags: instrumentation,${{ matrix.os }},library,binary
          name: instrumentation-${{ matrix.os }}

  #
  # Run all tests on macOS and Windows.
  #
  # Unlike the other jobs, this job doesn't use Docker (and thus skips some
  # tests that require dependencies not easily installable without Docker).
  #
  # It also runs most tests for different packages sequentially
  # to prevent the combinatorial explosion of the number of parallel jobs,
  # to minimize the number of times we need to install MySQL using the package manager
  # (PostgreSQL and MongoDB are provided by GitHub Actions out of the box), and
  # minimize the time spent waiting for a free runner.
  #
  no-docker-client-functional:
    timeout-minutes: 40
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        node: [14]
        queryEngine: ['library', 'binary']
        # Commented out as we still have limited capacity for macOS runners
        # When we have more capacity we can shard again
        # shard: ['1', '2']

    needs: detect_jobs_to_run
    if: |
      ${{
        contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') ||
        contains(needs.detect_jobs_to_run.outputs.jobs, '-client-')
      }}
    steps:
      - uses: actions/checkout@v3

      - name: Prerequisites
        shell: bash
        run: |
          echo "TEST_SKIP_MSSQL=true" >> $GITHUB_ENV
          echo "TEST_SKIP_MONGODB=true" >> $GITHUB_ENV
          echo "TEST_SKIP_COCKROACHDB=true" >> $GITHUB_ENV
          echo "TEST_SKIP_VITESS=true" >> $GITHUB_ENV
          echo "TEST_MONGO_URI_MIGRATE=mongodb://localhost:27017/tests-migrate" >> $GITHUB_ENV
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set up PostgreSQL
        run: bash .github/workflows/scripts/setup-postgres.sh

      - name: Set up MySQL
        run: bash .github/workflows/scripts/setup-mysql.sh

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: Test packages/client
        # Commented out as we still have limited capacity for macOS runners
        # When we have more capacity we can shard again
        # run: pnpm run test:functional:code --shard=${{matrix.shard}}/2
        # No shard:
        run: pnpm run test:functional:code
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          # allow Node.js to allocate at most 14GB of heap on macOS and 7GB on Windows
          # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
          NODE_OPTIONS: "${{ matrix.os == 'macos-latest' && '--max-old-space-size=14336' || '--max-old-space-size=7168' }}"
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/functional/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        with:
          files: ./packages/client/src/__tests__/coverage/clover.xml
          flags: client,${{ matrix.os }},${{ matrix.queryEngine }}
          name: client-functional-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Upload test results to BuildPulse for flaky test detection
        # Only run this step for branches where we have access to secrets.
        # Run this step even when the tests fail. Skip if the workflow is cancelled.
        if: env.HAS_BUILDPULSE_SECRETS == 'true' && !cancelled() && github.event_name == 'schedule'
        uses: Workshop64/buildpulse-action@main
        with:
          account: 17219288
          repository: 192925833
          path: packages
          key: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
          secret: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}

      - uses: actions/upload-artifact@v3
        if: github.event_name == 'schedule'
        with:
          name: ${{ github.job }}_${{ matrix.os }}_node-${{ matrix.node }}_${{ matrix.queryEngine }}_junit.xml
          path: packages/*/junit*.xml

  no-docker:
    timeout-minutes: 40
    runs-on: ${{ matrix.os }}

    needs: detect_jobs_to_run
    if: |
      ${{
        contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') ||
        contains(needs.detect_jobs_to_run.outputs.jobs, '-internals-') ||
        contains(needs.detect_jobs_to_run.outputs.jobs, '-migrate-') ||
        contains(needs.detect_jobs_to_run.outputs.jobs, '-cli-') ||
        contains(needs.detect_jobs_to_run.outputs.jobs, '-client-')
      }}

    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        node: [14]
        queryEngine: ['library', 'binary']

    steps:
      - uses: actions/checkout@v3

      - name: Prerequisites
        shell: bash
        run: |
          echo "TEST_SKIP_MSSQL=true" >> $GITHUB_ENV
          echo "TEST_SKIP_MONGODB=true" >> $GITHUB_ENV
          echo "TEST_SKIP_COCKROACHDB=true" >> $GITHUB_ENV
          echo "TEST_MONGO_URI_MIGRATE=mongodb://localhost:27017/tests-migrate" >> $GITHUB_ENV
          echo "PRISMA_CLI_QUERY_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV
          echo "PRISMA_CLIENT_ENGINE_TYPE=${{ matrix.queryEngine }}" >> $GITHUB_ENV

      - name: Set up PostgreSQL
        run: bash .github/workflows/scripts/setup-postgres.sh

      - name: Set up MySQL
        run: bash .github/workflows/scripts/setup-mysql.sh

      - uses: pnpm/action-setup@v2.2.4
        with:
          version: 7

      - uses: actions/setup-node@v3
        with:
          cache: 'pnpm'
          node-version: ${{ matrix.node }}

      - run: pnpm i && pnpm -r dev
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: Test packages/internals
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }} || contains(needs.detect_jobs_to_run.outputs.jobs, '-internals-') }}
        run: pnpm run test --testTimeout=40000
        working-directory: packages/internals
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/internals/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }} || contains(needs.detect_jobs_to_run.outputs.jobs, '-internals-') }}
        with:
          files: ./packages/internals/src/__tests__/coverage/clover.xml
          flags: internals,${{ matrix.os }},${{ matrix.queryEngine }}
          name: internals-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Test packages/client (old suite)
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}
        run: pnpm run test-notypes --testTimeout=40000
        working-directory: packages/client
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          # Allow Node.js to allocate at most a certain amount heap on macOS and a different amount on Windows
          # Note that this value should be lower than the total amount of RAM available
          # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
          NODE_OPTIONS: "${{ matrix.os == 'macos-latest' && '--max-old-space-size=14336' || '--max-old-space-size=3072' }}"
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/client/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-client-') }}
        with:
          files: ./packages/client/src/__tests__/coverage/clover.xml
          flags: client,${{ matrix.os }},${{ matrix.queryEngine }}
          name: client-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Test packages/migrate
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-migrate-') }}
        run: pnpm run test --testTimeout=40000
        working-directory: packages/migrate
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/migrate/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-migrate-') }}
        with:
          files: ./packages/migrate/src/__tests__/coverage/clover.xml
          flags: migrate,${{ matrix.os }},${{ matrix.queryEngine }}
          name: migrate-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Test packages/cli
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-cli-') }}
        run: pnpm run test --testTimeout=40000
        working-directory: packages/cli
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/cli/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') || contains(needs.detect_jobs_to_run.outputs.jobs, '-cli-') }}
        with:
          files: ./packages/cli/src/__tests__/coverage/clover.xml
          flags: cli,${{ matrix.os }},${{ matrix.queryEngine }}
          name: cli-${{ matrix.os }}-${{ matrix.queryEngine }}

      - name: Test packages/debug
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/debug
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/debug/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/debug/src/__tests__/coverage/clover.xml
          flags: debug,${{ matrix.os }},library,binary
          name: debug-${{ matrix.os }}

      - name: Test packages/engine-core
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/engine-core
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/engine-core/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/engine-core/src/__tests__/coverage/clover.xml
          flags: engine-core,${{ matrix.os }},library,binary
          name: engine-core-${{ matrix.os }}

      - name: Test packages/generator-helper
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/generator-helper
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/generator-helper/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/generator-helper/src/__tests__/coverage/clover.xml
          flags: generator-helper,${{ matrix.os }},library,binary
          name: generator-helper-${{ matrix.os }}

      - name: Test packages/get-platform
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/get-platform
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/get-platform/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/get-platform/src/__tests__/coverage/clover.xml
          flags: get-platform,${{ matrix.os }},library,binary
          name: get-platform-${{ matrix.os }}

      - name: Test packages/fetch-engine
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/fetch-engine
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/fetch-engine/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/fetch-engine/src/__tests__/coverage/clover.xml
          flags: fetch-engine,${{ matrix.os }},library,binary
          name: fetch-engine-${{ matrix.os }}

      - name: Test packages/engines
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        run: pnpm run test
        working-directory: packages/engines
        env:
          CI: true
          SKIP_GIT: true
          GITHUB_CONTEXT: ${{ toJson(github) }}
          JEST_JUNIT_SUITE_NAME: '${{ github.job }}/engines/${{ matrix.os }}/node-${{ matrix.node }}/${{ matrix.queryEngine }}'
          JEST_JUNIT_UNIQUE_OUTPUT_NAME: true

      - uses: codecov/codecov-action@v3
        if: ${{ contains(needs.detect_jobs_to_run.outputs.jobs, '-all-') }}
        with:
          files: ./packages/engines/src/__tests__/coverage/clover.xml
          flags: engines,${{ matrix.os }},library,binary
          name: engines-${{ matrix.os }}

      - name: Upload test results to BuildPulse for flaky test detection
        # Only run this step for branches where we have access to secrets.
        # Run this step even when the tests fail. Skip if the workflow is cancelled.
        if: env.HAS_BUILDPULSE_SECRETS == 'true' && !cancelled() && github.event_name == 'schedule'
        uses: Workshop64/buildpulse-action@main
        with:
          account: 17219288
          repository: 192925833
          path: packages
          key: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
          secret: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}

      - uses: actions/upload-artifact@v3
        if: github.event_name == 'schedule'
        with:
          name: ${{ github.job }}_${{ matrix.os }}_node-${{ matrix.node }}_${{ matrix.queryEngine }}_junit.xml
          path: packages/*/junit*.xml
